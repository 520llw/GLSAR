#!/bin/bash

# SAR Ship Detection Web Interface Launcher
# ä¸€é”®å¯åŠ¨SARèˆ°èˆ¹æ£€æµ‹Webç•Œé¢

clear
echo "========================================"
echo "ðŸš¢ SAR Ship Detection Web Demo"
echo "========================================"
echo ""

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ£€æŸ¥Python
echo -n "ðŸ“¦ Checking Python... "
if ! command -v python &> /dev/null; then
    echo -e "${RED}âŒ Not found!${NC}"
    exit 1
fi
PYTHON_VERSION=$(python --version 2>&1 | awk '{print $2}')
echo -e "${GREEN}âœ… ${PYTHON_VERSION}${NC}"

# æ£€æŸ¥Gradioï¼ˆå¿½ç•¥ä¾èµ–è­¦å‘Šï¼‰
echo -n "ðŸ“¦ Checking Gradio... "
python -c "import gradio" 2>/dev/null
if [ $? -ne 0 ]; then
    echo -e "${YELLOW}âš ï¸  Not installed${NC}"
    echo "   Installing Gradio..."
    pip install gradio --quiet --disable-pip-version-check
    if [ $? -eq 0 ]; then
        echo -e "   ${GREEN}âœ… Installed${NC}"
    else
        echo -e "   ${RED}âŒ Installation failed${NC}"
        exit 1
    fi
else
    GRADIO_VERSION=$(python -c "import gradio; print(gradio.__version__)" 2>/dev/null)
    echo -e "${GREEN}âœ… ${GRADIO_VERSION}${NC}"
fi

# æ£€æŸ¥PyTorch
echo -n "ðŸ“¦ Checking PyTorch... "
python -c "import torch" 2>/dev/null
if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Not installed!${NC}"
    echo ""
    echo "Please install PyTorch first:"
    echo "  pip install torch torchvision"
    exit 1
fi
TORCH_VERSION=$(python -c "import torch; print(torch.__version__)" 2>/dev/null)
echo -e "${GREEN}âœ… ${TORCH_VERSION}${NC}"

# æ£€æŸ¥CUDA
echo -n "ðŸ”§ Checking CUDA... "
python -c "import torch; assert torch.cuda.is_available()" 2>/dev/null
if [ $? -eq 0 ]; then
    CUDA_VERSION=$(python -c "import torch; print(torch.version.cuda)" 2>/dev/null)
    echo -e "${GREEN}âœ… CUDA ${CUDA_VERSION}${NC}"
else
    echo -e "${YELLOW}âš ï¸  CPU mode (slower)${NC}"
fi

# æ£€æŸ¥OpenCV
echo -n "ðŸ“¦ Checking OpenCV... "
python -c "import cv2" 2>/dev/null
if [ $? -ne 0 ]; then
    echo -e "${YELLOW}âš ï¸  Not installed${NC}"
    echo "   Installing OpenCV..."
    pip install opencv-python --quiet --disable-pip-version-check
else
    CV_VERSION=$(python -c "import cv2; print(cv2.__version__)" 2>/dev/null)
    echo -e "${GREEN}âœ… ${CV_VERSION}${NC}"
fi

# æ£€æŸ¥checkpoint
echo -n "ðŸ“ Checking checkpoint... "
if [ ! -f "checkpoints/best_model.pth" ]; then
    echo -e "${YELLOW}âš ï¸  Not found${NC}"
    echo "   Expected: checkpoints/best_model.pth"
    echo "   You'll need to load it manually in the web interface"
else
    CHECKPOINT_SIZE=$(du -h checkpoints/best_model.pth | awk '{print $1}')
    echo -e "${GREEN}âœ… Found (${CHECKPOINT_SIZE})${NC}"
fi

# æ£€æŸ¥é…ç½®æ–‡ä»¶
echo -n "ðŸ“ Checking config... "
if [ ! -f "config/sar_ship_config.py" ]; then
    echo -e "${RED}âŒ Config file missing!${NC}"
    exit 1
fi
echo -e "${GREEN}âœ…${NC}"

# æ£€æŸ¥æ¨¡åž‹æ–‡ä»¶
echo -n "ðŸ§  Checking model files... "
if [ ! -f "models/detectors/denodet_enhanced.py" ]; then
    echo -e "${RED}âŒ Model files missing!${NC}"
    exit 1
fi
echo -e "${GREEN}âœ…${NC}"

echo ""
echo "========================================"
echo "ðŸš€ Starting Web Interface..."
echo "========================================"
echo ""
echo "Server will start at:"
echo "   Local:   http://localhost:7860"
echo "   Network: http://$(hostname -I | awk '{print $1}'):7860"
echo ""
echo "Press Ctrl+C to stop the server"
echo ""
echo "----------------------------------------"

# å¯åŠ¨åº”ç”¨ï¼ˆæŠ‘åˆ¶pipè­¦å‘Šï¼‰
export PYTHONWARNINGS="ignore"
python app.py 2>&1 | grep -v "dependency conflicts" | grep -v "botocore" | grep -v "openxlab"